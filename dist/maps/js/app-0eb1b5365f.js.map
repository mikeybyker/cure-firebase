{"version":3,"sources":["js/app.js"],"names":["angular","module","factory","utils","getRepeat","n","Array","getAverage","total","votes","Math","floor","$q","$log","Discog","Utils","initTrack","releaseId","trackId","userId","track","getTrack","promise","$loaded","then","getUserRating","rating","ratings","getRatings","$value","vote","value","update","reject","status","statusText","promiseRank","promiseRatings","$save","promiseTrack","setRank","getRankData","all","average","title","id","albumId","reason","deferred","defer","destroy","$destroy","getUserRatings","component","bindings","max","onVote","controller","this","templateUrl","showDetails","$location","Auth","signout","$signOut","path","active","location","$ctrl","user","$onAuthStateChanged","TrackController","$routeParams","$timeout","$scope","Vote","toastr","event","results","info","error","vm","uid","data","onHidden","getCover","image","cover","$on","$inject","ReleaseController","getRelease","release","tracks","$window","firebaseRef","ref","firebase","database","args","prototype","slice","call","arguments","length","child","pathRef","i","isArray","isString","Error","join","timestamp","ServerValue","TIMESTAMP","$firebaseObject","$firebaseArray","FirebaseUtils","getAlbum","albumRef","once","dataSnapshot","val","getTracks","tracksRef","api","getDiscog","artist","discogRef","orderByChild","coverRef","getRanks","limit","ranksRef","limitToLast","rankRef","set","ratingsRef","trackRef","DiscogController","discog","$firebaseAuth","oauthLogin","providerName","$signInWithPopup","result","warn","topTracks","runBlock","$rootScope","next","previous","run","routeConfig","$routeProvider","whenAuthenticated","route","resolve","$requireSignIn","when","controllerAs","requireNoAuth","auth","otherwise","redirectTo","config","$logProvider","toastrConfig","debugEnabled","allowHtml","timeOut","positionClass","preventDuplicates","preventOpenDuplicates","maxOpened","progressBar","$templateCache","put"],"mappings":"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","file":"js/app-0eb1b5365f.js","sourcesContent":["(function() {\r\n    'use strict';\r\n\r\n    angular\r\n        .module('cure', [\r\n            'ngAnimate',\r\n            'ngCookies',\r\n            'ngTouch',\r\n            'ngSanitize',\r\n            'ngMessages',\r\n            'ngAria',\r\n            'ngResource',\r\n            'ngRoute',\r\n            'firebase',\r\n            'mm.foundation',\r\n            'toastr']);\r\n\r\n})();\n(function() {\r\n    'use strict';\r\n\r\n    angular\r\n        .module('cure')\r\n        .factory('Utils', function(){\r\n\r\n            var utils = {\r\n\r\n                getRepeat : function(n){\r\n                    return new Array(n);\r\n                },\r\n\r\n                getAverage : function(total, votes){\r\n                    if(total === 0 || votes === 0){\r\n                        return 0;\r\n                    }\r\n                    return Math.floor(total/votes) || 0;\r\n                }\r\n            };\r\n\r\n            return utils;\r\n        });\r\n\r\n})();\r\n\n(function() {\r\n    'use strict';\r\n\r\n    angular\r\n        .module('cure')\r\n        .factory('Vote', function($q, $log, Discog, Utils){\r\n\r\n            var ratings,\r\n                track;\r\n\r\n            function initTrack(releaseId, trackId, userId){\r\n                track = Discog.getTrack(releaseId, trackId);\r\n                var promise = track.$loaded();\r\n                return promise\r\n                    .then(function(track){\r\n                        return getUserRating(userId, trackId);\r\n                    })\r\n                    .then(function(rating){\r\n                        return {track:track, ratings:ratings};\r\n                        // return reject({status:503, statusText:'Just broken...'}); // to test...\r\n                    });\r\n            }\r\n\r\n            function getUserRating(userId, trackId){\r\n                ratings = Discog.getRatings(userId, trackId);\r\n                // $value null if never voted, else $value is the number last voted\r\n                return ratings\r\n                        .$loaded()\r\n                        .then(function(rating){\r\n                            if( rating.$value === null){\r\n                                rating.$value = 0;\r\n                            }\r\n                            return rating;\r\n                        });\r\n            }\r\n            function vote(trackId, value){\r\n                if(!value){\r\n                    return reject({status:400, statusText:'No value sent to vote!'});\r\n                } else if(!trackId){\r\n                    return reject({status:400, statusText:'Missing trackId, can\\'t vote...'});\r\n                }\r\n                if(ratings.$value === 0){\r\n                    // never voted\r\n                    // $log.info('Vote: never voted');\r\n                    track.votes++;\r\n                    track.total += value;\r\n                } else {\r\n                    // $log.info('Vote: has voted before');\r\n                    // Voted before : add value, remove ratings.$value\r\n                    track.total += value - ratings.$value;\r\n                }\r\n                ratings.$value = value;\r\n                return update(trackId);\r\n            }\r\n\r\n            function update(trackId){\r\n                var promiseRank,\r\n                    promiseRatings = ratings.$save(),\r\n                    promiseTrack = track.$save();\r\n\r\n                promiseRank = Discog.setRank(trackId, getRankData(track));\r\n                // promiseRank = reject({status:405, statusText:'test error'}); // to test\r\n\r\n                return $q.all([promiseRatings, promiseTrack, promiseRank]);\r\n            }\r\n\r\n            function getRankData(track){\r\n                return {\r\n                    average: Utils.getAverage(track.total,track.votes),\r\n                    title: track.title,\r\n                    id : track.id,\r\n                    albumId : track.albumId\r\n                };\r\n            }\r\n\r\n            function reject(reason){\r\n                reason = reason || {status:404, statusText:'Not Found'};\r\n                var deferred = $q.defer();\r\n                deferred.reject(reason);\r\n                return deferred.promise;\r\n            }\r\n\r\n            function destroy(){\r\n                ratings.$destroy();\r\n                track.$destroy();\r\n                return true;\r\n            }\r\n\r\n            return {\r\n                vote: function(trackId, value){\r\n                    return vote(trackId, value);\r\n                },\r\n                initTrack: function(releaseId, trackId, userId){\r\n                    return initTrack(releaseId, trackId, userId);\r\n                },\r\n                getUserRatings: function(){\r\n                    return ratings;\r\n                },\r\n                destroy: function(){\r\n                    return destroy();\r\n                }\r\n            }\r\n\r\n        });\r\n\r\n})();\n(function() {\r\n    'use strict';\r\n\r\n    angular\r\n        .module('cure')\r\n        .component('votingButtons', {\r\n            bindings:{\r\n                votes: '<',\r\n                max: '<',\r\n                onVote: '&'\r\n            },\r\n            controller: function(Utils){\r\n                this.getRepeat = Utils.getRepeat;\r\n            },\r\n            templateUrl: 'app/components/vote/vote.html'\r\n        });\r\n\r\n})();\r\n\n(function() {\r\n    'use strict';\r\n\r\n    angular\r\n        .module('cure')\r\n        .component('ratingBar', {\r\n            bindings:{\r\n                total: '<',\r\n                votes: '<',\r\n                max: '<',\r\n                showDetails: '<'\r\n            },\r\n            controller: function($log, Utils){\r\n\r\n                this.getRepeat = Utils.getRepeat;\r\n                this.getAverage = Utils.getAverage;\r\n\r\n                // this.$onInit = function() {\r\n                //     $log.info('ratingBar component initialized');\r\n                // };\r\n            },\r\n            templateUrl: 'app/components/rating/rating.html'\r\n        });\r\n\r\n})();\r\n\r\n// Note: component defaults to controllerAs: '$ctrl'\n(function() {\r\n    'use strict';\r\n\r\n    angular\r\n        .module('cure')\r\n        .component('navbar', {\r\n            controller: function($location, $log, Auth){\r\n\r\n                var $ctrl = this; // to access from $onAuthStateChanged\r\n                this.user = null;\r\n                this.signout = signout;\r\n                this.active = active;\r\n\r\n                function signout() {\r\n                    Auth\r\n                        .$signOut()\r\n                        .then(function(){\r\n                            $location.path('/');\r\n                        });\r\n                }\r\n\r\n                function active(location) {\r\n                    return location === $location.path();\r\n                }\r\n\r\n                // Equiv. of $window.firebase.onAuthStateChanged\r\n                Auth.$onAuthStateChanged(function(user) {\r\n                    $ctrl.user = user;\r\n                });\r\n            },\r\n            templateUrl: 'app/components/navbar/navbar.html'\r\n        });\r\n\r\n})();\r\n\n(function() {\r\n    'use strict';\r\n\r\n    angular\r\n        .module('cure')\r\n        .controller('TrackController', TrackController);\r\n\r\n    function TrackController($routeParams, $timeout, $log, $scope, $location, Vote, Discog, Utils, user, toastr) {\r\n        var vm = this,\r\n            track,\r\n            votes,\r\n            releaseId = $routeParams.id,\r\n            trackId = $routeParams.track;\r\n\r\n        vm.onVote = onVote;\r\n        vm.getAverage = Utils.getAverage;\r\n\r\n        if(!releaseId || !trackId || !user.uid){\r\n            $location.path('/');\r\n            return;\r\n        }\r\n\r\n        Vote.initTrack(releaseId, trackId, user.uid)\r\n            .then(function(data){\r\n                track = vm.track = data.track;\r\n                votes = vm.votes = data.ratings;\r\n            }).catch(function(reason){\r\n                toastr.error(reason.statusText, 'Error', {\r\n                    onHidden: function(){\r\n                        $location.path('/');\r\n                    }\r\n                });\r\n            });\r\n\r\n        // Don't like... A child route would be better (ui-router) - or a ref in a service - rather\r\n        // than making another request\r\n        Discog.getCover($routeParams.id).then(function(image){\r\n            vm.cover = image;\r\n        });\r\n\r\n        function onVote(event){\r\n            Vote.vote(trackId, event.value)\r\n                .then(function(results){\r\n                   // $log.info('onVote : vote counted!', results);\r\n                }, function(reason){\r\n                    $log.info('Error : ', reason);\r\n                    toastr.error(reason.statusText, 'Error');\r\n                });\r\n        }\r\n\r\n        // To clean up angularfire references (stop permission errors...)\r\n        $scope.$on('$destroy', function() {\r\n            // vm.cover.$destroy(); // only need when using $firebaseObject : not when using .once\r\n            Vote.destroy && Vote.destroy();\r\n        });\r\n\r\n    }\r\n    \r\n})();\r\n\n(function() {\r\n    'use strict';\r\n\r\n    angular\r\n        .module('cure')\r\n        .controller('ReleaseController', ReleaseController);\r\n\r\n    function ReleaseController($routeParams, $location, Discog, toastr) {\r\n        var vm = this;\r\n        vm.releaseId = $routeParams.id;\r\n\r\n        // Use once : don't need to keep on tracking/waiting for update\r\n        Discog.getRelease($routeParams.id).then(function(data){\r\n            vm.release =  data[0];\r\n            vm.tracks =  data[1];\r\n        }, function(reason){\r\n            toastr.error(reason.statusText, 'Error', {\r\n                onHidden: function(){\r\n                    $location.path('/');\r\n                }\r\n            });\r\n        });\r\n\r\n    }\r\n\r\n})();\r\n\n(function() {\r\n    'use strict';\r\n\r\n    angular\r\n        .module('cure')\r\n        .factory('FirebaseUtils', function($window){\r\n\r\n            function firebaseRef(path) {\r\n                // var ref = $window.firebase.database().ref(),\r\n                var ref = firebase.database().ref(),\r\n                    args = Array.prototype.slice.call(arguments);\r\n                if( args.length ) {\r\n                    ref = ref.child(pathRef(args));\r\n                }\r\n                return ref;\r\n            }\r\n            function pathRef(args) {\r\n                for (var i = 0; i < args.length; i++) {\r\n                    if (angular.isArray(args[i])) {\r\n                        args[i] = pathRef(args[i]);\r\n                    }\r\n                    else if(!angular.isString(args[i])) {\r\n                        throw new Error('Argument ' + i + ' to firebaseRef is not a string: ' + args[i]);\r\n                    }\r\n                }\r\n                return args.join('/');\r\n            }\r\n\r\n            return {\r\n                // There's only a global reference - seems odd for angularfire not to include service, but still.\r\n                firebase : function(){\r\n                    return firebase.database().ref();\r\n                    // Same as:\r\n                    // return $window.firebase.database().ref();\r\n                },\r\n                timestamp: firebase.database.ServerValue.TIMESTAMP,\r\n                // Same as:\r\n                // timestamp: $window.firebase.database.ServerValue.TIMESTAMP,\r\n                \r\n                ref : firebaseRef\r\n            }\r\n        });\r\n\r\n})();\r\n\n(function() {\r\n    'use strict';\r\n\r\n    angular\r\n        .module('cure')\r\n        .factory('Discog', function($timeout, $q, $firebaseObject, $firebaseArray, FirebaseUtils){\r\n\r\n            function getAlbum (releaseId){\r\n                var albumRef = FirebaseUtils.ref('releases/' + releaseId);\r\n\r\n                return albumRef.once('value').then(function(dataSnapshot){\r\n                    return $timeout(function() {\r\n                        return dataSnapshot.val();\r\n                    });\r\n                });\r\n            }\r\n\r\n            function getTracks (releaseId){\r\n                var tracksRef = FirebaseUtils.ref('tracks/' + releaseId);\r\n\r\n                return tracksRef.once('value').then(function(dataSnapshot){\r\n                    return $timeout(function() {\r\n                        return dataSnapshot.val();\r\n                    });\r\n                });\r\n            }\r\n\r\n            var api = {\r\n\r\n                getDiscog : function(artist){\r\n                    var discogRef = FirebaseUtils\r\n                        .ref('artist/' + artist + '/discog')\r\n                        .orderByChild('releaseYear');\r\n\r\n                    return $firebaseArray(discogRef);\r\n                },\r\n\r\n                getCover : function(releaseId){\r\n                    var coverRef = FirebaseUtils.ref('releases/' + releaseId + '/coverFront');\r\n\r\n                    return coverRef.once('value').then(function(dataSnapshot){\r\n                        return $timeout(function() {\r\n                            return dataSnapshot.val();\r\n                        });\r\n                    });\r\n                },\r\n\r\n                getRanks : function(limit){\r\n                    var ranksRef = FirebaseUtils\r\n                        .ref('ranks')\r\n                        .orderByChild('average')\r\n                        .limitToLast(limit);\r\n\r\n                    return $firebaseArray(ranksRef);\r\n                },\r\n\r\n                // Don't need to track or keep hold of, so don't keep the overhead of a $firebaseObject\r\n                setRank : function(trackId, data){\r\n                    var rankRef = FirebaseUtils\r\n                        .ref('ranks/' + trackId)\r\n                        .set(data);\r\n                    return rankRef;\r\n                },\r\n\r\n                getRatings : function(userId, trackId){\r\n                    var ratingsRef = FirebaseUtils\r\n                        .ref('users/' + userId + '/ratings/' + trackId);\r\n\r\n                    return $firebaseObject(ratingsRef);\r\n                },\r\n\r\n                getTrack : function(releaseId, trackId){\r\n                    var trackRef = FirebaseUtils\r\n                        .ref('tracks/' + releaseId + '/' + trackId);\r\n\r\n                    return $firebaseObject(trackRef);\r\n                },\r\n\r\n                // Get the album (or whatever) plus its tracks\r\n                getRelease : function(releaseId){\r\n                    return $q.all([getAlbum(releaseId), getTracks(releaseId)]);\r\n                }\r\n\r\n            };\r\n\r\n            return api;\r\n\r\n        });\r\n\r\n})();\r\n\n(function() {\r\n    'use strict';\r\n\r\n    angular\r\n        .module('cure')\r\n        .controller('DiscogController', DiscogController);\r\n\r\n    function DiscogController($scope, Discog) {\r\n        var vm = this;\r\n\r\n        vm.discog = Discog.getDiscog('The Cure');\r\n\r\n        // To clean up angularfire references (stop permission errors...)\r\n        $scope.$on('$destroy', function() {\r\n            vm.discog.$destroy && vm.discog.$destroy();\r\n        });\r\n\r\n    }\r\n})();\n(function() {\r\n    'use strict';\r\n\r\n    angular\r\n        .module('cure')\r\n        .factory('Auth', function($firebaseAuth){\r\n            return $firebaseAuth();\r\n        });\r\n\r\n})();\r\n\n(function() {\r\n    'use strict';\r\n\r\n    angular\r\n        .module('cure')\r\n        .controller('AuthController', function($location, $log, $scope, Discog, Auth, toastr){\r\n\r\n            var vm = this;\r\n            vm.oauthLogin = oauthLogin;\r\n            vm.user = null;\r\n            // Show top X by votes : will update live as/when top X changes\r\n            vm.topTracks = Discog.getRanks(5);\r\n\r\n            function oauthLogin(providerName) {\r\n                if(!providerName){\r\n                    return;\r\n                }\r\n                Auth.$signInWithPopup(providerName)\r\n                    .then(function(result) {\r\n                        $location.path('/release');\r\n                    }).catch(function(reason) {\r\n                        $log.warn('error ::: ', reason);\r\n                        toastr.error(reason.statusText, 'Error', {\r\n                            onHidden: function(){\r\n                                $location.path('/');\r\n                            }\r\n                        });\r\n                    });\r\n            }\r\n\r\n            Auth.$onAuthStateChanged(function(user) {\r\n                vm.user = user;\r\n            });\r\n\r\n            // To clean up angularfire references (stop permission errors...)\r\n            $scope.$on('$destroy', function() {\r\n                vm.topTracks.$destroy && vm.topTracks.$destroy();\r\n            });\r\n\r\n        });\r\n\r\n})();\r\n\n(function() {\r\n    'use strict';\r\n\r\n    angular\r\n        .module('cure')\r\n        .run(runBlock);\r\n\r\n    function runBlock($log, $window, $rootScope, $location) {\r\n\r\n        var r = $rootScope.$on('$routeChangeError', function(event, next, previous, error) {\r\n            // We can catch the error thrown when the $requireSignIn promise is rejected\r\n            // and redirect the user back to the home page\r\n            if (error === 'AUTH_REQUIRED') {\r\n                $location.path('/');\r\n            }\r\n        });\r\n\r\n    }\r\n\r\n})();\r\n\n(function() {\r\n    'use strict';\r\n\r\n    angular\r\n        .module('cure')\r\n        .config(routeConfig);\r\n\r\n    function routeConfig($routeProvider) {\r\n\r\n        $routeProvider.whenAuthenticated = function (path, route) {\r\n            route.resolve = route.resolve || {};\r\n            route.resolve.user = ['Auth', function (Auth) {\r\n                return Auth.$requireSignIn();\r\n            }];\r\n            $routeProvider.when(path, route);\r\n            return this;\r\n        }\r\n\r\n        $routeProvider\r\n            .when('/', {\r\n                templateUrl: 'app/auth/login.html',\r\n                controller: 'AuthController',\r\n                controllerAs: 'vm',\r\n                resolve: {\r\n                    requireNoAuth: ['$location', 'Auth', function($location, Auth){\r\n                        return Auth.$requireSignIn().then(function(auth){\r\n                            $location.path('/discog');\r\n                        }, function(error){\r\n                            return;\r\n                        });\r\n                    }]\r\n                }\r\n            })\r\n            .when('/about', {\r\n                templateUrl: 'app/about/about.html'\r\n            })\r\n            .whenAuthenticated('/discog', {\r\n                templateUrl: 'app/discog/discog.html',\r\n                controller: 'DiscogController',\r\n                controllerAs: 'vm'\r\n            })\r\n            .whenAuthenticated('/discog/:id', {\r\n                templateUrl: 'app/release/release.html',\r\n                controller: 'ReleaseController',\r\n                controllerAs: 'vm'\r\n            })\r\n            .whenAuthenticated('/discog/:id/:track', {\r\n                templateUrl: 'app/track/track.html',\r\n                controller: 'TrackController',\r\n                controllerAs: 'vm'\r\n            })\r\n            .otherwise({\r\n                redirectTo: '/'\r\n            });\r\n        }\r\n\r\n})();\r\n\n(function() {\r\n    'use strict';\r\n\r\n    angular\r\n        .module('cure')\r\n        .config(config);\r\n\r\n    function config($logProvider, toastrConfig) {\r\n\r\n        $logProvider.debugEnabled(true);\r\n\r\n        toastrConfig.allowHtml = true;\r\n        toastrConfig.timeOut = 2000;\r\n        toastrConfig.positionClass = 'toast-top-right';\r\n        toastrConfig.preventDuplicates = false;     // true prevents same as last toast : don't want\r\n        toastrConfig.preventOpenDuplicates = true;  // true prevents the same toast as is currently showing\r\n        toastrConfig.maxOpened = 1;\r\n        toastrConfig.progressBar = true;\r\n\r\n    }\r\n\r\n})();\r\n\nangular.module(\"cure\").run([\"$templateCache\", function($templateCache) {$templateCache.put(\"app/about/about.html\",\"<div class=container><div class=row><div class=\\\"small-12 text-center columns\\\"><h1>About</h1></div><div class=\\\"small-12 text-center columns\\\"><div class=\\\"panel text-left\\\"><p>An <a href=https://www.angularjs.org/ >Angular</a> 1.5 (@1.5.8) app with a <a href=https://firebase.google.com/ >Firebase</a> backend. View and rate albums/releases by The Cure. These are from my collection - CDs only.<br>I used <a href=http://www.collectorz.com/music/ >Music Collector</a> to scan my CDs and export the data, with a little massaging to get a Firebase friendly denormalized state.<br>One day I might get round to adding my vinyl etc. too - though that would take a long, long time. I have lots :-)</p><p>The CD cover images are as exported from Music Collector - far too many to rename to something nice, so they are what they are.</p></div></div></div></div>\");\n$templateCache.put(\"app/auth/login.html\",\"<div class=container><div class=row><div class=\\\"large-12 text-center columns\\\"><div class=\\\"panel login-panel\\\"><div class=login-buttons ng-if=!vm.user><button class=\\\"secondary button\\\" ng-click=\\\"vm.oauthLogin(\\'google\\')\\\">Google</button> <button class=\\\"secondary button\\\" ng-click=\\\"vm.oauthLogin(\\'facebook\\')\\\">Facebook</button></div></div></div></div><div class=row><div class=\\\"small-8 small-offset-2 text-center columns\\\"><ul class=\\\"menu simple topthree\\\"><li ng-repeat=\\\"track in vm.topTracks | orderBy:\\'-average\\'\\\"><small>{{track.title}} ({{track.average}})</small></li></ul></div></div></div>\");\n$templateCache.put(\"app/discog/discog.html\",\"<div class=container><div class=row><div class=\\\"large-12 text-center columns\\\"><img src=images/the-cure.png alt=\\\"The Cure\\\"></div></div><div class=\\\"row small-up-2 medium-up-3 large-up-4\\\"><div class=\\\"column release\\\" ng-repeat=\\\"release in vm.discog\\\"><a ng-href=\\\"#/discog/{{ release.$id}}\\\">{{ release.title}}</a></div></div></div>\");\n$templateCache.put(\"app/release/release.html\",\"<div class=container><div class=row ng-hide=!vm.release.artist><div class=\\\"small-12 text-center columns\\\"><a ng-href=#/discog><img src=images/the-cure.png alt=\\\"The Cure\\\"></a><h1>{{vm.release.title}}</h1><small>{{vm.release.releaseDate}}</small></div><div class=\\\"small-12 medium-6 text-center columns\\\"><div class=panel><img class=cover ng-src=images/covers/{{vm.release.coverFront}}><ul class=\\\"menu simple\\\"><li><small>Label: {{vm.release.label}}</small></li><li><small>Tracks: {{vm.release.tracks}}</small></li></ul></div></div><div class=\\\"small-12 medium-6 panel-column columns\\\"><div class=\\\"panel text-left\\\"><ol><li class=tracks ng-repeat=\\\"track in vm.tracks\\\"><a ng-href=#/discog/{{vm.releaseId}}/{{track.id}}>{{track.title}}</a></li></ol></div></div></div></div>\");\n$templateCache.put(\"app/track/track.html\",\"<div class=container><div class=row ng-hide=!vm.track.artist><div class=\\\"small-12 text-center columns\\\"><a ng-href=#/discog><img src=images/the-cure.png alt=\\\"The Cure\\\"></a><h1 class=release-title><a ng-href=#/discog/{{vm.track.albumId}}>{{vm.track.albumTitle}}</a></h1><small>{{vm.track.releaseDate}}</small></div><div class=\\\"small-12 medium-6 text-center columns\\\"><div class=panel><img class=cover ng-src=images/covers/{{vm.cover}}></div></div><div class=\\\"small-12 medium-6 panel-column columns\\\"><div class=\\\"panel panel-ratings\\\"><h2>{{vm.track.title}}</h2><rating-bar total=vm.track.total votes=vm.track.votes max=5 show-details=true></rating-bar><ul class=\\\"menu simple\\\"><li>Position: {{vm.track.position}}</li><li>Length: {{vm.track.length}}</li></ul><voting-buttons on-vote=vm.onVote($event) votes=vm.votes max=5></voting-buttons></div></div></div></div>\");\n$templateCache.put(\"app/components/navbar/navbar.html\",\"<div class=top-bar><div class=top-bar-left><ul class=menu><li ng-class=\\\"{ active: $ctrl.active(\\'/\\') || $ctrl.active(\\'/discog\\') }\\\"><a ng-href=#/ >Home</a></li></ul></div><div class=top-bar-right ng-if=$ctrl.user><ul class=\\\"menu float-right\\\"><li ng-class=\\\"{ active: $ctrl.active(\\'/about\\') }\\\"><a ng-href=#/about>About</a></li><li><button class=\\\"hollow button success\\\" ng-click=$ctrl.signout()>Sign Out</button></li></ul></div></div>\");\n$templateCache.put(\"app/components/rating/rating.html\",\"<div><div class=rating><span ng-class=\\\"{ \\'selected\\': ($ctrl.total/$ctrl.votes) >= ($index + 0.5)}\\\" ng-repeat=\\\"i in $ctrl.getRepeat($ctrl.max) track by $index\\\">☆</span></div><div ng-if=$ctrl.showDetails><small>Votes Cast: {{$ctrl.votes}}</small> | <small>Rating: {{$ctrl.getAverage($ctrl.total, $ctrl.votes)}}</small></div></div>\");\n$templateCache.put(\"app/components/vote/vote.html\",\"<div class=rate-buttons><h4>Rate</h4><div class=button-group><button class=button ng-class=\\\"{ \\'alert\\': $ctrl.votes.$value === ($index + 1)}\\\" ng-click=\\\"$ctrl.onVote({$event: {value: ($index + 1)}});\\\" ng-repeat=\\\"i in $ctrl.getRepeat($ctrl.max) track by $index\\\">{{$index + 1}}</button></div><small>Your Rating: {{$ctrl.votes.$value || 0}}</small></div>\");}]);"],"sourceRoot":"/source/"}